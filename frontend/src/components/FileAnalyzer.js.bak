export class FileAnalyzer {
    constructor() {
        this.currentFile = null;
        this.abortController = null;
        this.isTranscribing = false;
        this.segmentsMap = new Map();

        this.initElements();
        this.initEvents();
    }

    // ç®€åŒ– DOM æŸ¥è¯¢
    $(id) {
        return document.getElementById(id);
    }

    // === å…ƒç´ åˆå§‹åŒ– ===
    initElements() {
        // é™æ€å…ƒç´ 
        this.uploadArea = this.$('uploadArea');
        this.uploadLoading = this.$('uploadLoading');
        this.fileInfo = this.$('fileInfo');
        this.fileNameEl = this.$('fileName');
        this.fileSizeEl = this.$('fileSize');
        this.transcribeFileBtn = this.$('transcribeFileBtn');
        this.progressContainer = this.$('progressContainer');
        this.progressFill = this.$('progressFill');
        this.fileTranscript = this.$('fileTranscript');

        // åŠ¨æ€åˆ›å»ºç¼ºå¤±çš„å…ƒç´ 
        this.statusMessage = this.ensureElement('statusMessage', this.createStatusMessageElement.bind(this));
        this.stopTranscribeBtn = this.ensureElement('stopTranscribeBtn', this.createStopButtonElement.bind(this));
        this.summaryContainer = this.ensureElement('summaryContainer', this.createSummaryContainerElement.bind(this));
        this.combinedTranscript = this.ensureElement('combinedTranscript', this.createCombinedTranscriptElement.bind(this));
    }

    // é€šç”¨ç¡®ä¿å…ƒç´ å­˜åœ¨
    ensureElement(id, creator) {
        let el = this.$(id);
        if (!el) {
            el = creator();
            const ref = this.getInsertionRef(id);
            if (ref && ref.parentNode) {
                ref.parentNode.insertBefore(el, ref.nextSibling);
            } else {
                document.body.appendChild(el);
            }
        }
        return el;
    }

    getInsertionRef(id) {
        if (id === 'statusMessage') return this.progressContainer;
        if (id === 'stopTranscribeBtn') return this.transcribeFileBtn;
        if (id === 'summaryContainer') return this.fileTranscript;
        if (id === 'combinedTranscript') return this.summaryContainer;
        return this.fileTranscript;
    }

    // === å…ƒç´ åˆ›å»ºå‡½æ•° ===
    createStatusMessageElement() {
        const el = document.createElement('div');
        el.id = 'statusMessage';
        el.className = 'status-message';
        Object.assign(el.style, {
            margin: '10px 0',
            padding: '8px 12px',
            borderRadius: '4px',
            fontSize: '14px'
        });
        return el;
    }

    createStopButtonElement() {
        const btn = document.createElement('button');
        btn.id = 'stopTranscribeBtn';
        btn.className = 'btn btn-danger';
        Object.assign(btn.style, {
            marginLeft: '10px',
            display: 'none'
        });
        btn.innerHTML = 'â¹ï¸ åœæ­¢å¤„ç†';
        return btn;
    }

    createSummaryContainerElement() {
        const container = document.createElement('div');
        container.id = 'summaryContainer';
        Object.assign(container.style, {
            marginTop: '15px',
            display: 'none'
        });
        container.innerHTML = `
            <div class="summary-box" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-top: 15px;">
                <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #4361ee; padding-bottom: 8px;">å¤„ç†æ‘˜è¦</h3>
                <div id="summaryContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;"></div>
            </div>
        `;
        return container;
    }

    createCombinedTranscriptElement() {
        const container = document.createElement('div');
        container.id = 'combinedTranscript';
        Object.assign(container.style, {
            marginTop: '20px',
            display: 'none'
        });
        container.innerHTML = `
            <div class="combined-transcript" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-top: 15px;">
                <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #4361ee; padding-bottom: 8px;">å®Œæ•´è½¬å½•ç»“æœ</h3>
                <div id="combinedContent" class="transcript-content" style="line-height: 1.6; font-size: 1.1rem; min-height: 100px;"></div>
            </div>
        `;
        return container;
    }

    // === äº‹ä»¶åˆå§‹åŒ– ===
    initEvents() {
        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        this.uploadArea.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'audio/*, .wav, .mp3, .m4a, .flac, .ogg';
            fileInput.onchange = (e) => {
                this.handleFileSelect(e.target.files[0]);
                fileInput.remove();
            };
            fileInput.click();
        });

        // æ‹–æ‹½æ”¯æŒ
        ['dragover', 'dragenter'].forEach(event => {
            this.uploadArea.addEventListener(event, (e) => {
                e.preventDefault();
                this.uploadArea.classList.add('dragover');
            });
        });

        this.uploadArea.addEventListener('dragleave', () => {
            this.uploadArea.classList.remove('dragover');
        });

        this.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            this.uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) this.handleFileSelect(file);
        });

        // æŒ‰é’®äº‹ä»¶
        this.transcribeFileBtn.addEventListener('click', () => this.startTranscription());
        if (this.stopTranscribeBtn) {
            this.stopTranscribeBtn.addEventListener('click', () => this.stopTranscription());
        }
    }

    // === UI æ§åˆ¶è¾…åŠ©æ–¹æ³• ===
    setVisibility(el, visible) {
        if (el) el.style.display = visible ? 'block' : 'none';
    }

    clearPreviousResults() {
        this.fileTranscript.innerHTML = 'æ–‡ä»¶è½¬å½•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
        this.fileTranscript.className = 'transcript-area';

        // åªä¿ç•™å¿…è¦çš„æ¸…ç©º
        ['summaryContent', 'combinedContent'].forEach(id => {
            const el = this.$(id);
            if (el) el.innerHTML = '';
        });

        [this.summaryContainer, this.combinedTranscript].forEach(el => {
            this.setVisibility(el, false);
        });

        if (this.progressFill) this.progressFill.style.width = '0%';
        this.setVisibility(this.progressContainer, false);

        if (this.statusMessage) {
            this.statusMessage.textContent = '';
            this.statusMessage.removeAttribute('style');
        }

        this.segmentsMap.clear();
    }

    resetUIForNewTranscription() {
        this.clearPreviousResults();
        this.setVisibility(this.progressContainer, true);
        this.fileTranscript.innerHTML = '<div class="loading" style="display: inline-block; margin-right: 8px;"></div> æ­£åœ¨å¤„ç†æ–‡ä»¶...';
        this.fileTranscript.classList.add('processing');
        this.setVisibility(this.stopTranscribeBtn, true);
        this.setVisibility(this.summaryContainer, true);
    }

    finalizeTranscription() {
        this.isTranscribing = false;
        this.transcribeFileBtn.disabled = false;
        this.transcribeFileBtn.innerHTML = '<span>å¼€å§‹è½¬æ–‡å­—</span>';
        this.setVisibility(this.uploadLoading, false);
        this.setVisibility(this.stopTranscribeBtn, false);
        this.fileTranscript.scrollIntoView({ behavior: 'smooth' });
    }

    // === ä¸šåŠ¡é€»è¾‘æ–¹æ³• ===
    handleFileSelect(file) {
        if (!file) return;

        const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
        if (file.size > MAX_FILE_SIZE) {
            this.showStatus(`âŒ æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ (æœ€å¤§ 100MB)ï¼Œå½“å‰å¤§å°: ${this.formatFileSize(file.size)}`, 'error');
            return;
        }

        this.currentFile = file;
        this.displayFileInfo(file);
        this.transcribeFileBtn.disabled = false;
        this.clearPreviousResults();
        this.showStatus(`âœ… å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`, 'success');
    }

    displayFileInfo(file) {
        this.fileNameEl.textContent = file.name;
        this.fileSizeEl.textContent = this.formatFileSize(file.size);
        this.setVisibility(this.fileInfo, true);
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    showStatus(message, type = 'info') {
        if (!this.statusMessage) return;

        this.statusMessage.textContent = message;

        const theme = {
            success: { bg: '#d4edda', color: '#155724', border: '#c3e6cb' },
            error: { bg: '#f8d7da', color: '#721c24', border: '#f5c6cb' },
            warning: { bg: '#fff3cd', color: '#856404', border: '#ffeeba' },
            info: { bg: '#d1ecf1', color: '#0c5460', border: '#bee5eb' }
        }[type] || theme.info;

        Object.assign(this.statusMessage.style, {
            backgroundColor: theme.bg,
            color: theme.color,
            border: `1px solid ${theme.border}`
        });

        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                if (this.statusMessage && this.statusMessage.textContent === message) {
                    this.statusMessage.textContent = '';
                    this.statusMessage.removeAttribute('style');
                }
            }, 3000);
        }
    }

    updateProgress(percent, message = '') {
        if (this.progressFill) {
            this.progressFill.style.width = `${percent}%`;
        }
        if (message) {
            this.showStatus(message, 'info');
        }
    }

    addSummaryInfo(summary) {
        const summaryContent = this.$('summaryContent');
        if (!summaryContent) return;

        summaryContent.innerHTML = '';

        const summaryItems = [
            { label: 'æ€»æ—¶é•¿', value: `${summary.total_duration}s` },
            { label: 'æ€»æ®µæ•°', value: summary.total_segments },
            { label: 'æˆåŠŸæ®µæ•°', value: summary.successful_segments },
            { label: 'å¤±è´¥æ®µæ•°', value: summary.failed_segments }
        ];

        if (summary.long_segments_count > 0) {
            summaryItems.push({ label: 'é•¿æ®µæ•°é‡', value: summary.long_segments_count });
        }

        if (summary.total_processing_time) {
            summaryItems.push({ label: 'æ€»å¤„ç†æ—¶é—´', value: `${summary.total_processing_time.toFixed(2)}s` });
        }

        summaryItems.forEach(item => {
            const itemDiv = document.createElement('div');
            Object.assign(itemDiv.style, {
                backgroundColor: '#f8fafc',
                padding: '10px',
                borderRadius: '8px',
                border: '1px solid #e2e8f0'
            });
            itemDiv.innerHTML = `
                <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 4px;">${item.label}</div>
                <div style="font-weight: bold; font-size: 1.1em; color: #1f2937;">${item.value}</div>
            `;
            summaryContent.appendChild(itemDiv);
        });

        this.setVisibility(this.summaryContainer, true);
    }

    appendToCombinedTranscript(text, segmentInfo = null) {
        const combinedContent = this.$('combinedContent');
        if (!combinedContent || !text?.trim()) return;

        // è®¡ç®—è¯­éŸ³é•¿åº¦
        let duration = 0;
        if (segmentInfo && segmentInfo.start_time !== undefined && segmentInfo.end_time !== undefined) {
            duration = (segmentInfo.end_time - segmentInfo.start_time).toFixed(2);
        } else if (segmentInfo && segmentInfo.duration) {
            duration = segmentInfo.duration;
        }

        let segmentHtml = '';
        
        // é•¿æ®µç‰¹æ®Šæ ·å¼
        if (segmentInfo && segmentInfo.is_long_segment) {
            segmentHtml = `
                <div class="long-segment-container" style="margin: 20px 0; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 10px rgba(245, 158, 11, 0.2);">
                    <div style="background: linear-gradient(to right, #fffbeb 0%, #fef3c7 100%); padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #fed7aa;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #f59e0b; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 1.1rem;">ğŸ”Š</span>
                            <strong style="color: #854d0e; font-size: 1.15rem; font-weight: 600;">é•¿è¯­éŸ³æ®µ #${segmentInfo.segment_index}</strong>
                        </div>
                        <span style="background: #fef3c7; color: #854d0e; padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 1rem; min-width: 70px; text-align: center;">
                            ${duration}s
                        </span>
                    </div>
                    <div style="padding: 18px; background: white;">
                        <div style="line-height: 1.7; font-size: 1.15rem; color: #1f2937; margin-bottom: 10px; font-weight: 500;">${text}</div>
                        <div style="font-size: 0.88em; color: #854d0e; display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #fef3c7;">
                            <span style="font-weight: 500;">â±ï¸ æ—¶é—´èŒƒå›´: [${segmentInfo.start_time.toFixed(2)}s - ${segmentInfo.end_time.toFixed(2)}s]</span>
                            ${segmentInfo.confidence ? `<span style="font-weight: 500;">âœ“ ç½®ä¿¡åº¦: ${(segmentInfo.confidence * 100).toFixed(1)}%</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        } 
        // æ™®é€šæ®µè½æ ·å¼ï¼ŒåŒ…å«è¯­éŸ³é•¿åº¦
        else if (segmentInfo) {
            segmentHtml = `
                <div class="transcript-paragraph" style="margin: 16px 0; padding: 14px 18px; border-radius: 10px; background: #f8fafc; border-left: 4px solid #3b82f6; box-shadow: 0 2px 5px rgba(0,0,0,0.03);">
                    <div style="display: flex; justify-content: space-between; font-size: 0.88em; color: #374151; margin-bottom: 10px; font-weight: 500;">
                        <span>æ®µ #${segmentInfo.segment_index}</span>
                        <span style="background: #dbeafe; color: #1e40af; padding: 3px 10px; border-radius: 15px; font-weight: 600;">
                            ${duration}s
                        </span>
                    </div>
                    <div style="line-height: 1.65; font-size: 1.08rem; color: #1e293b; font-weight: 500;">${text}</div>
                    <div style="font-size: 0.83em; color: #4b5563; margin-top: 8px; display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px dashed #bfdbfe;">
                        <span>ğŸ•’ [${segmentInfo.start_time.toFixed(2)}s - ${segmentInfo.end_time.toFixed(2)}s]</span>
                        ${segmentInfo.confidence ? `<span>âœ“ ${(segmentInfo.confidence * 100).toFixed(1)}%</span>` : ''}
                    </div>
                </div>
            `;
        } 
        // æ— ä¿¡æ¯çš„æ™®é€šæ–‡æœ¬
        else {
            segmentHtml = `<div style="margin: 16px 0; line-height: 1.65; font-size: 1.08rem;">${text}</div>`;
        }

        combinedContent.insertAdjacentHTML('beforeend', segmentHtml);
        combinedContent.scrollTop = combinedContent.scrollHeight;
        this.setVisibility(this.combinedTranscript, true);
    }

    // === è½¬å½•æµç¨‹ ===
    stopTranscription() {
        if (this.abortController) {
            this.abortController.abort();
            this.showStatus('â¹ï¸ å·²åœæ­¢å¤„ç†', 'warning');
            if (this.stopTranscribeBtn) this.stopTranscribeBtn.disabled = true;
        }
    }

    async startTranscription() {
        if (!this.currentFile) {
            this.showStatus('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶', 'error');
            return;
        }

        if (this.isTranscribing) {
            this.showStatus('âš ï¸ å¤„ç†ä¸­ï¼Œè¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡', 'warning');
            return;
        }

        this.isTranscribing = true;
        this.transcribeFileBtn.disabled = true;
        this.transcribeFileBtn.innerHTML = '<span class="loading" style="display: inline-block; margin-right: 8px;"></span><span>å¤„ç†ä¸­...</span>';
        this.setVisibility(this.uploadLoading, true);
        this.resetUIForNewTranscription();

        try {
            this.abortController = new AbortController();

            const formData = new FormData();
            formData.append('file', this.currentFile);
            formData.append('stream', 'true');
            formData.append('vad_enabled', 'true');

            const response = await fetch('/transcribe/file', {
                method: 'POST',
                body: formData,
                signal: this.abortController.signal
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.detail || `HTTPé”™è¯¯: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const result = JSON.parse(line);
                        switch (result.type) {
                            case 'initialization':
                                this.handleInitialization(result);
                                break;
                            case 'segments_summary':
                                this.handleSegmentsSummary(result);
                                break;
                            case 'segment_result':
                                this.handleSegmentResult(result);
                                break;
                            case 'segment_error':
                                this.handleSegmentError(result);
                                break;
                            case 'final_summary':
                                this.handleFinalSummary(result);
                                break;
                            default:
                                console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', result.type);
                        }
                    } catch (e) {
                        console.error('è§£æJSONå¤±è´¥:', e, line);
                        this.showStatus(`âŒ è§£æé”™è¯¯: ${e.message}`, 'error');
                    }
                }
            }
        } catch (error) {
            console.error('è½¬å½•å¤±è´¥:', error);
            if (error.name === 'AbortError') {
                this.showStatus('â¹ï¸ å¤„ç†å·²åœæ­¢', 'warning');
            } else {
                this.showStatus(`âŒ è½¬å½•å¤±è´¥: ${error.message}`, 'error');
                this.fileTranscript.innerHTML = `
                    <div style="padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                        <h3 style="color: #ef4444; margin-top: 0;">å¤„ç†å¤±è´¥</h3>
                        <p style="color: #b91c1c; margin: 10px 0;">${error.message}</p>
                        <p style="color: #6b7280; font-size: 0.9em;">è¯¦ç»†ä¿¡æ¯: ${error.toString()}</p>
                    </div>
                `;
                this.fileTranscript.classList.remove('processing');
            }
        } finally {
            this.finalizeTranscription();
        }
    }

    // === æ¶ˆæ¯å¤„ç† ===
    handleInitialization(result) {
        this.fileNameEl.textContent = result.filename;
        this.fileSizeEl.textContent = this.formatFileSize(result.file_size);
        this.updateProgress(5, `å‡†å¤‡å¤„ç† ${result.total_segments} ä¸ªè¯­éŸ³æ®µ...`);
        this.showStatus(`åˆå§‹åŒ–å®Œæˆ: ${result.filename} (${this.formatFileSize(result.file_size)})`, 'info');
    }

    handleSegmentsSummary(result) {
        this.showStatus(`ğŸ¯ æ£€æµ‹åˆ° ${result.total_segments} ä¸ªè¯­éŸ³æ®µï¼Œå¼€å§‹è½¬å½•...`, 'info');
        this.updateProgress(10, `å¼€å§‹å¤„ç† ${result.total_segments} ä¸ªæ®µ`);
    }

    handleSegmentResult(result) {
        // ä¸å†æ›´æ–°æ®µè¯¦æƒ…ï¼Œåªæ›´æ–°è¿›åº¦å’Œå®Œæ•´è½¬å½•
        this.updateProgress(result.progress, `å¤„ç†ä¸­: æ®µ #${result.segment_index}/${result.total_segments}`);
        this.showStatus(
            `âœ… æ®µ #${result.segment_index}: ${result.text?.slice(0, 30)}${(result.text?.length > 30) ? '...' : ''}`,
            'success'
        );

        // ä¿®å¤ï¼šé•¿æ®µé‡å»ºé€»è¾‘
        if (result.is_long_segment) {
            const key = `original-${result.original_index}`;
            
            // åˆå§‹åŒ–é•¿æ®µå®¹å™¨
            if (!this.segmentsMap.has(key)) {
                this.segmentsMap.set(key, {
                    segments: [],
                    totalSubSegments: result.sub_segment_count || 0,
                    originalIndex: result.original_index
                });
            }
            
            const longSegmentData = this.segmentsMap.get(key);
            longSegmentData.segments.push({
                sub_segment_index: result.sub_segment_index,
                text: result.text || '',
                start_time: result.start_time,
                end_time: result.end_time,
                confidence: result.confidence || 0.9
            });
            
            // è°ƒè¯•ä¿¡æ¯
            console.log(`é•¿æ®µ ${result.original_index} è¿›åº¦: ${longSegmentData.segments.length}/${longSegmentData.totalSubSegments} å­æ®µ`);
            
            // åˆ¤æ–­æ˜¯å¦æ”¶é›†å®Œæ‰€æœ‰å­æ®µ
            if (longSegmentData.segments.length >= longSegmentData.totalSubSegments) {
                // æ’åºå¹¶åˆå¹¶å­æ®µ
                const sortedSegments = longSegmentData.segments.sort((a, b) => a.sub_segment_index - b.sub_segment_index);
                const combinedText = sortedSegments.map(s => s.text.trim()).filter(t => t).join(' ').trim();
                const firstSegment = sortedSegments[0];
                const lastSegment = sortedSegments[sortedSegments.length - 1];
                
                // è®¡ç®—å¹³å‡ç½®ä¿¡åº¦
                const avgConfidence = sortedSegments.reduce((sum, s) => sum + (s.confidence || 0), 0) / sortedSegments.length;
                
                console.log(`âœ… åˆå¹¶é•¿æ®µ ${result.original_index}: "${combinedText}"`);
                
                if (combinedText) {
                    // ä¼ é€’å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬ is_long_segment æ ‡å¿—
                    this.appendToCombinedTranscript(combinedText, {
                        segment_index: result.original_index,
                        start_time: firstSegment.start_time,
                        end_time: lastSegment.end_time,
                        confidence: avgConfidence,
                        is_long_segment: true,
                        duration: (lastSegment.end_time - firstSegment.start_time).toFixed(2)
                    });
                }
                
                // æ¸…ç†å·²å¤„ç†çš„é•¿æ®µæ•°æ®
                this.segmentsMap.delete(key);
            }
        } else {
            // æ™®é€šæ®µç›´æ¥æ·»åŠ 
            this.appendToCombinedTranscript(result.text || 'ï¼ˆæ— æ–‡æœ¬ï¼‰', {
                segment_index: result.segment_index,
                start_time: result.start_time,
                end_time: result.end_time,
                confidence: result.confidence,
                duration: (result.end_time - result.start_time).toFixed(2)
            });
        }
    }

    handleSegmentError(result) {
        this.showStatus(`âŒ æ®µ #${result.segment_index} å¤±è´¥: ${result.error}`, 'error');
    }

    handleFinalSummary(result) {
        this.showStatus('âœ… æ‰€æœ‰æ®µå¤„ç†å®Œæˆï¼', 'success');
        this.updateProgress(100, 'å¤„ç†å®Œæˆ');

        this.addSummaryInfo({
            total_duration: result.total_duration,
            total_segments: result.total_segments,
            successful_segments: result.successful_segments || result.total_segments,
            failed_segments: result.failed_segments || 0,
            long_segments_count: result.long_segments_count || 0,
            total_processing_time: result.total_processing_time || 0
        });

        // ç®€åŒ–å®ŒæˆçŠ¶æ€
        this.fileTranscript.innerHTML = `
            <div style="padding: 25px; text-align: center; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border-radius: 16px; border: 1px solid #bbf7d0;">
                <div style="font-size: 4rem; margin-bottom: 15px; color: #10b981;">âœ“</div>
                <h2 style="color: #065f46; margin-bottom: 12px; font-size: 1.8rem;">è½¬å½•å·²å®Œæˆ</h2>
                <p style="font-size: 1.1rem; color: #166534; margin-bottom: 20px;">
                    å®Œæ•´è½¬å½•ç»“æœå’Œå¤„ç†æ‘˜è¦å·²åœ¨ä¸‹æ–¹æ˜¾ç¤º
                </p>
                <button onclick="document.getElementById('combinedTranscript').scrollIntoView({behavior: 'smooth'})" 
                        style="margin-top: 12px; background: #10b981; color: white; border: none; padding: 10px 28px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1.05rem; transition: all 0.2s; box-shadow: 0 3px 8px rgba(16, 185, 129, 0.4);">
                        æŸ¥çœ‹å®Œæ•´è½¬å½•
                </button>
            </div>
        `;
        this.fileTranscript.classList.remove('processing');
        
        this.showStatus(`ğŸ‰ è½¬å½•å®Œæˆï¼${(result.successful_segments || result.total_segments)}/${result.total_segments} æ®µæˆåŠŸ`, 'success');
    }
}